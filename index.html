<script>
  let icaTable = null;

  // 当前所有图共享的 x 轴范围（格式：[maxAge, minAge]，保持 reversed）
  let currentXRange = null;

  // 当前“初始范围”（用于 reset axes 回到初始状态；会随表格筛选更新）
  let initialXRange = null;

  // 防止 relayout 循环触发
  let isSyncing = false;

  // 记录已绑定过事件的 plot，避免重复绑定
  const boundRelayout = new Set();

  const PLOT_IDS = ["icaPlot", "mgcaPlot", "d13cPlot", "d18oPlot"];

  function safeNumber(v) {
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : null;
  }

  function getFilteredDataFromTable() {
    if (!icaTable) return [];
    return icaTable.rows({ search: "applied" }).data().toArray();
  }

  function buildTrace(rows, yColIndex, name, unit) {
    const ages = [];
    const ys = [];
    const labels = [];

    rows.forEach(r => {
      const age = safeNumber(r[1]);
      const y = safeNumber(r[yColIndex]);
      if (age !== null && y !== null) {
        ages.push(age);
        ys.push(y);
        labels.push(r[0]);
      }
    });

    return {
      x: ages,
      y: ys,
      mode: "markers",
      type: "scatter",
      name,
      text: labels,
      hovertemplate:
        "Sample: %{text}<br>Age: %{x} Ma<br>" + name + ": %{y} " + unit + "<extra></extra>",
      marker: { size: 7, opacity: 0.8 }
    };
  }

  function computeInitialXRangeFromRows(rows) {
    // 用 I/Ca 可用点的年龄范围作为“初始范围”
    // 如果某次筛选下 I/Ca 没点，就回退到全表 Age 范围
    const icaTrace = buildTrace(rows, 2, "I/Ca", "μmol/mol");
    let ages = (icaTrace.x || []).filter(v => Number.isFinite(v));

    if (!ages.length) {
      // fallback：从 rows 的 Age 列取范围
      ages = rows.map(r => safeNumber(r[1])).filter(v => v !== null);
    }

    const maxAge = ages.length ? Math.max(...ages) : 4000;
    const minAge = ages.length ? Math.min(...ages) : 0;
    return [maxAge, minAge]; // reversed
  }

  function plotScatter(divId, trace, yTitle, xRange) {
    const layout = {
      margin: { l: 70, r: 20, t: 20, b: 60 },
      xaxis: {
        title: "Age (Ma)",
        autorange: false,
        range: xRange,     // 强制统一范围
        fixedrange: false
      },
      yaxis: { title: yTitle }
    };
    Plotly.newPlot(divId, [trace], layout, { responsive: true });
  }

  function isPlotVisible(id) {
    const el = document.getElementById(id);
    if (!el) return false;
    if (id === "icaPlot") return true;
    return el.style.display !== "none";
  }

  // 同步所有可见图的 x 轴范围（包括 I/Ca）
  function syncXRangeToAllPlots(xRange, sourceId) {
    PLOT_IDS.forEach(id => {
      if (!isPlotVisible(id)) return;
      if (id === sourceId) return;
      Plotly.relayout(id, { "xaxis.range": xRange });
    });
  }

  // 绑定任意图的缩放/框选/重置事件，实现双向联动
  function bindRelayoutForPlot(plotId) {
    const el = document.getElementById(plotId);
    if (!el) return;
    if (boundRelayout.has(plotId)) return;

    el.on("plotly_relayout", (e) => {
      if (isSyncing) return;

      // 1) reset axes / double-click 触发 autorange
      if (e["xaxis.autorange"] === true) {
        // 回到初始范围（随表格筛选而更新的 initialXRange）
        if (!initialXRange) return;
        currentXRange = [...initialXRange];
        isSyncing = true;
        syncXRangeToAllPlots(currentXRange, null);
        // 同步 source 自己（有时需要强制一下）
        Plotly.relayout(plotId, { "xaxis.range": currentXRange, "xaxis.autorange": false });
        isSyncing = false;
        return;
      }

      // 2) 捕获 xaxis range（两种写法）
      let r0 = e["xaxis.range[0]"];
      let r1 = e["xaxis.range[1]"];
      if (r0 === undefined || r1 === undefined) {
        const r = e["xaxis.range"];
        if (Array.isArray(r) && r.length === 2) {
          r0 = r[0]; r1 = r[1];
        }
      }

      if (r0 !== undefined && r1 !== undefined) {
        currentXRange = [r0, r1];
        isSyncing = true;
        syncXRangeToAllPlots(currentXRange, plotId);
        isSyncing = false;
      }
    });

    boundRelayout.add(plotId);
  }

  function bindRelayoutAll() {
    PLOT_IDS.forEach(id => {
      if (!isPlotVisible(id)) return;
      bindRelayoutForPlot(id);
    });
  }

  function updatePlots() {
    if (!icaTable) return;

    const rows = getFilteredDataFromTable();

    // 每次表格筛选变化时，更新“初始范围”
    initialXRange = computeInitialXRangeFromRows(rows);

    // 如果用户尚未缩放（currentXRange 为空），就用初始范围
    if (!currentXRange) currentXRange = [...initialXRange];

    // --- Mandatory I/Ca ---
    const icaTrace = buildTrace(rows, 2, "I/Ca", "μmol/mol");
    plotScatter("icaPlot", icaTrace, "I/Ca (μmol/mol)", currentXRange);

    // --- Optional plots ---
    const showMgCa = document.getElementById("showMgCa").checked;
    const showD13C = document.getElementById("showD13C").checked;
    const showD18O = document.getElementById("showD18O").checked;

    // Mg/Ca (col index 3) —— 注意单位：mol/mol
    const mgcaDiv = document.getElementById("mgcaPlot");
    mgcaDiv.style.display = showMgCa ? "block" : "none";
    if (showMgCa) {
      const t = buildTrace(rows, 3, "Mg/Ca", "mol/mol");
      plotScatter("mgcaPlot", t, "Mg/Ca (mol/mol)", currentXRange);
    } else {
      Plotly.purge("mgcaPlot");
    }

    // δ13C (col index 4)
    const d13cDiv = document.getElementById("d13cPlot");
    d13cDiv.style.display = showD13C ? "block" : "none";
    if (showD13C) {
      const t = buildTrace(rows, 4, "δ13C", "‰");
      plotScatter("d13cPlot", t, "δ13C (‰)", currentXRange);
    } else {
      Plotly.purge("d13cPlot");
    }

    // δ18O (col index 5)
    const d18oDiv = document.getElementById("d18oPlot");
    d18oDiv.style.display = showD18O ? "block" : "none";
    if (showD18O) {
      const t = buildTrace(rows, 5, "δ18O", "‰");
      plotScatter("d18oPlot", t, "δ18O (‰)", currentXRange);
    } else {
      Plotly.purge("d18oPlot");
    }

    // 重新绘图后，绑定（或确保绑定）所有可见图的联动事件
    bindRelayoutAll();

    // 强制所有可见图统一到 currentXRange（防止首次渲染轻微差异）
    isSyncing = true;
    syncXRangeToAllPlots(currentXRange, null);
    isSyncing = false;
  }

  function renderTable(rows) {
    const tbody = document.querySelector("#icaTable tbody");
    tbody.innerHTML = "";

    rows.forEach(row => {
      const tr = document.createElement("tr");

      function addCell(v, isLink) {
        const td = document.createElement("td");
        if (isLink && v) {
          const a = document.createElement("a");
          const vv = String(v).trim();
          const url = vv.startsWith("http") ? vv : ("https://doi.org/" + vv);
          a.href = url;
          a.textContent = url;
          a.target = "_blank";
          td.appendChild(a);
        } else {
          td.textContent = (v === null || v === undefined) ? "" : v;
        }
        tr.appendChild(td);
      }

      addCell(row.Sample_ID);
      addCell(row.Age_Ma);
      addCell(row.I_Ca_umol_per_mol);
      addCell(row.Mg_Ca_mmol_per_mol);
      addCell(row.delta13C);
      addCell(row.delta18O);
      addCell(row.Reference);
      addCell(row.DOI, true);

      tbody.appendChild(tr);
    });

    if (!icaTable) {
      icaTable = $("#icaTable").DataTable({
        pageLength: 25,
        order: [[1, "asc"]]
      });
      icaTable.on("draw", () => {
        // 表格筛选变化：重置 currentXRange（让新筛选的“初始范围”生效）
        currentXRange = null;
        updatePlots();
      });
    } else {
      icaTable.clear();
      $("#icaTable tbody tr").each(function () {
        const rowData = [];
        $(this).find("td").each(function () {
          rowData.push($(this).text());
        });
        icaTable.row.add(rowData);
      });
      icaTable.draw();
    }

    // 初次加载：让当前范围 = 初始范围
    currentXRange = null;
    updatePlots();
  }

  function loadCSV() {
    Papa.parse("data/ica_database.csv", {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: function (results) {
        const rows = results.data
          .filter(r => r.Sample_ID)
          .map(r => ({
            Sample_ID: r.Sample_ID,
            I_Ca_umol_per_mol: r.I_Ca_umol_per_mol,
            Mg_Ca_mmol_per_mol: r.Mg_Ca_mmol_per_mol,
            delta13C: r.delta13C,
            delta18O: r.delta18O,
            Age_Ma: r.Age_Ma,
            Reference: r.Reference,
            DOI: r.DOI
          }));
        renderTable(rows);
      },
      error: function (err) {
        console.error("Error loading CSV:", err);
      }
    });
  }

  function bindControls() {
    ["showMgCa", "showD13C", "showD18O"].forEach(id => {
      document.getElementById(id).addEventListener("change", () => {
        // 切换显示不改变 currentXRange（保持你当前 zoom 视角）
        updatePlots();
      });
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    bindControls();
    loadCSV();
  });
</script>
